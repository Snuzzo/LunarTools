#!/system/bin/sh
#
# dsixda was here - some original scripting was needed
# Kludgy hack to help with kernels
boot=$(grep -i "boot" /proc/emmc | sed 's/.*boot\(.*\)<\/recovery.*/\1/' | sed 's/:[^:]*$//')
recovery=$(grep -i "recovery" /proc/emmc | sed 's/.*boot\(.*\)<\/recovery.*/\1/' | sed 's/:[^:]*$//')
#Let's not rely on static values, we will get them from emmc hardware instead
DATE=$(date +"%m%d%y")
clear
echo "Loading"
sleep 1
clear
echo "Loading ."
sleep 1
clear
echo "Loading . ."
sleep 1
clear
echo "Loading . . ."
sleep 1
clear
echo "NO SPACES or Special characters"
echo "Enter name of current rom [Aa-Zz|0-9]:"
read currentrom
if [ ! -d "/sdcard2/lunar" ]; then
mkdir /sdcard2/lunar
fi
cd /sdcard2/lunar
echo
echo "1) Flash a previously saved boot.img from cmdline script"
echo "2) Flash a recovery.img"
echo "3) Update current kernel with an AnyKernel zImage"
echo "4) Flash boot.img from zip and auto-reboot to recovery"
echo
echo "Choose number selection[99 = abort]:"
read menu
        case "$menu" in
                "1")
			grep_cmd=`find ./boot* | grep -i \\.img$`
			echo "Previous configurations:" 
			echo
			for filename in $grep_cmd 
			    do
 			     count=$(($count+1))

 			     filename=`echo $filename | sed 's/temp_space/ /g'`

   			   # Store file names in an array
     			 file_array[$count]=$filename

			      echo "  ($count) $filename" >> temp.list
  			  done

  			  more temp.list
 			  rm temp.list

			    echo
			    echo -n "Enter selection number to flash (exit = 0): "

    			read enterNumber
    			echo
			if [ "$enterNumber" == "0" ]
    			then
      			exit 0
			fi
			if [ "`echo $enterNumber | sed 's/[0-9]*//'`" == "" ] || [ "enterNumber"=="1" ]
    			then
      			file_chosen=${file_array[$enterNumber]}
			fi
			echo "Last chance before we flash" 
			echo "You chose $file_chosen"
			echo 
			echo "1) Yes; I am ready flash it right away"
			echo "2) No; let's just save it for later"
			echo "Confirm flash?"
			read confirm
			case "$confirm" in
				"1")
					echo "Flashing selection in ..."
					echo "5"
					sleep 1
					echo "4"
					sleep 1
					echo "3"
					sleep 1
					echo "2"
					sleep 1
					echo "1"
					sleep 1
					dd if=$file_chosen of=/dev/block/$boot 2>/dev/null
					echo "Please Reboot to recovery....."
					echo ".... and Wipe Dalvik Cache & Cache"
					echo "GoodBye!"
					reboot recovery
					;;
				"2")
					echo "Fine, I will be here when you get back :)"
					echo "This message will self-destruct in ..."
					echo "5"
					sleep 1
					echo "4"
					sleep 1
					echo "3"
					sleep 1
					echo "2"
					sleep 1
					echo "1"
					sleep 1
					echo "P O O F!"
					exit
					;;
			esac
		$confirm
		;;
                "2")
			grep_cmd=`find ./recovery* | grep -i \\.img$`
			echo "Recoveries found:" 
			echo
			for filename in $grep_cmd 
			    do
 			     count=$(($count+1))

 			     filename=`echo $filename | sed 's/temp_space/ /g'`

   			   # Store file names in an array
     			 file_array[$count]=$filename

			      echo "  ($count) $filename" >> temp.list
  			  done

  			  more temp.list
 			  rm temp.list

			    echo
			    echo -n "Enter selection number to flash (exit = 0): "

    			read enterNumber
    			echo
			if [ "$enterNumber" == "0" ]
    			then
      			exit 0
			fi
			if [ "`echo $enterNumber | sed 's/[0-9]*//'`" == "" ] || [ "enterNumber"=="1" ]
    			then
      			file_chosen=${file_array[$enterNumber]}
			fi
			echo "Last chance before we flash" 
			echo "You chose $file_chosen"
			echo 
			echo "1) Yes; I am ready flash it right away"
			echo "2) No; let's just save it for later"
			echo "Confirm flash?"
			read confirm
			case "$confirm" in
				"1")
					echo "Backup current recovery?"
					echo "1) Yes"
					echo "2) No"
					read backup
					case "$backup" in
						"1")
							echo "Input name of recovery backup [Aa-Zz|0-9]:"
							read recoverybackup
							dd if=/dev/block/$recovery of=/sdcard2/lunar/recovery_$recoverybackup_$DATE.img 2>/dev/null
							echo "Your current recovery was saved to SDCard/Lunar dir as recovery_$recoverybackup_$DATE.img"
							;;
						"2")
							echo "Skipping creation of a recovery backup"
							;;
					esac
					$backup
					echo "Flashing selection in ..."
					echo "5"
					sleep 1
					echo "4"
					sleep 1
					echo "3"
					sleep 1
					echo "2"
					sleep 1
					echo "1"
					sleep 1
					dd if=$file_chosen of=/dev/block/$recovery 2>/dev/null
					echo "Done flashing....."
					echo "GoodBye!"
					exit
					;;
				"2")
					echo "Fine, I will be here when you get back :)"
					echo "This message will self-destruct in ..."
					echo "5"
					sleep 1
					echo "4"
					sleep 1
					echo "3"
					sleep 1
					echo "2"
					sleep 1
					echo "1"
					sleep 1
					echo "P O O F!"
					exit
					;;
			esac
			$confirm
			;;
		"3")
			cd /sdcard2/			
			grep_cmd1=`find -name Funky-Kernel* | grep -i \\.zip$`
			grep_cmd2=`find -name Funky_Sense* | grep -i \\.zip$`
			cd /sdcard2/lunar
			grep_cmd3=`find zimage*`
			grep_cmd=`echo $grep_cmd1 $grep_cmd2 $grep_cmd3`
			echo "zImages found:" 
			echo
			for filename in $grep_cmd 
			    do
 			     count=$(($count+1))

 			     filename=`echo $filename | sed 's/temp_space/ /g'`

   			   # Store file names in an array
     			 file_array[$count]=$filename

			      echo "  ($count) $filename" >> temp.list
  			  done

  			  more temp.list
 			  rm temp.list

			    echo
			    echo -n "Enter selection number to flash (exit = 0): "

    			read enterNumber
    			echo
			if [ "$enterNumber" == "0" ]
    			then
      			exit 0
			fi
			if [ "`echo $enterNumber | sed 's/[0-9]*//'`" == "" ] || [ "enterNumber"=="1" ]
    			then
      			file_chosen=${file_array[$enterNumber]}
			fi
			echo "Last chance before we flash" 
			echo "You chose $file_chosen"
			echo 
			echo "1) Yes; I am ready flash it right away"
			echo "2) No; let's just save it for later"
			echo "Confirm flash?"
			read confirm
			case "$confirm" in
				"1")
					echo "Flashing selection in ..."
					echo "5"
					sleep 1
					echo "4"
					sleep 1
					echo "3"
					sleep 1
					echo "2"
					sleep 1
					echo "1"
					sleep 1
					if [[ $file_chosen == *.zip ]]; then
					file_chosen=$(echo $file_chosen | sed -e "s|./|/sdcard2/|")  
					zimage=$(echo $file_chosen | sed "s/.*Funky/zimageFunky/" | sed -e "s|.zip||")
					md51=$(md5sum $file_chosen | cut -d ' ' -f 1)
					md52=$(echo $file_chosen | sed -e "s|.zip|.md5|")
					if [ -e $md52 ]; then
					md52=$(cat $md52 | cut -d ' ' -f 1)
					if [ "$md51" == "$md52" ]; then
					echo "Zip MD5 Checksum matches"
					else
					echo "MD5 checksum mismatch: Aborting script"
					exit 
					fi
					fi
					unzip -e -o $file_chosen lunarmenu/$zimage -d /sdcard2/lunar/ 2> /dev/null
					unzip -e -o $file_chosen kernel/zImage -d /sdcard2/lunar/ 2> /dev/null
					if [ -e zImage ]; then
					mv zImage $zimage
					fi
					sum1=$(sha1sum $zimage | cut -d ' ' -f 1)
					else
					sum1=$(sha1sum $file_chosen | cut -d ' ' -f 1)
					fi
					if [ ! -d "/sdcard2/temp" ]; then
					#-- Checking if temp exists if not we will create it
					mkdir /sdcard2/temp
					fi
					dd if=/dev/block/$boot of=/sdcard2/temp/tempboot.img 2>/dev/null
					abootimg -x /sdcard2/temp/tempboot.img > /dev/null
					sum2=$(sha1sum zImage | cut -d ' ' -f 1)
					cp /sdcard2/temp/tempboot.img /sdcard2/lunar/boot_last_known_good.img
					echo "Pulled a copy of your current boot.img to lunar/boot_last_known_good.img"
					#-- The next line is dependent on the placement of abootimg
					cd /sdcard2/lunar
					if [[ $file_chosen == *.zip ]]; then
					size1=$(stat -c %s $zimage)
					else
					size1=$(stat -c %s $file_chosen)
					fi
					if [[ $file_chosen == *.zip ]]; then
					abootimg -u /sdcard2/temp/tempboot.img -k $zimage > /dev/null
					else
					abootimg -u /sdcard2/temp/tempboot.img -k $file_chosen > /dev/null
					fi
					size2=$(stat -c %s /sdcard2/lunar/initrd.img)
					size=$(($size1 + $size2 + 1048576))
					printf -v hexsize "%x" "$size"
					sed -i "s/bootsize.*/bootsize = 0x$hexsize/g" /sdcard2/lunar/bootimg.cfg
					abootimg -u /sdcard2/temp/tempboot.img -f /sdcard2/lunar/bootimg.cfg > /dev/null
					cd /sdcard2/temp
					dd if=/sdcard2/temp/tempboot.img of=/dev/block/$boot 2>/dev/null
					dd if=/dev/block/$boot of=/sdcard2/temp/tempboot.img 2>/dev/null
					abootimg -x /sdcard2/temp/tempboot.img > /dev/null
					sed -i "s/bootsize.*/bootsize = 0x$hexsize/g" bootimg.cfg
					abootimg -u /sdcard2/temp/tempboot.img -f bootimg.cfg > /dev/null
					sum3=$(sha1sum zImage | cut -d ' ' -f 1)
					if [[ $file_chosen == *.zip ]]; then
					echo "New zImage sha1sum is $sum1"
					else
					echo "$file_chosen sha1sum is $sum1"
					fi
					echo "Current zImage sha1sum is $sum2"
					if [ "$sum3" == "$sum1" ]; then
					echo "flashed ok"
					if [[ $file_chosen == *.zip ]]; then
					currentboot=$(echo $zimage | sed -e "s|zimage|boot_"$currentrom"_|")
					else
					currentboot=$(echo $file_chosen | sed -e "s|zimage|boot_"$currentrom"_|")
					fi
					echo "Copy of your updated boot.img is at lunar/$currentboot.img"
					mv /sdcard2/temp/tempboot.img /sdcard2/lunar/$currentboot.img
					rm /sdcard2/lunar/boot_last_known_good.img
					else
					echo "flash unsuccessful"
					echo "restoring boot_last_known_good.img"
					dd if=/sdcard2/lunar/boot_last_known_good.img of=/dev/block/$boot 2>/dev/null
					fi
					rm -r /sdcard2/temp
					if [[ $file_chosen == *.zip ]]; then
					rm /sdcard2/lunar/zImage
					rm /sdcard2/lunar/initrd.img
					rm /sdcard2/lunar/bootimg.cfg
					rm /data/dalvik-cache/*
					fi
					echo '--wipe_cache' >> /cache/recovery/command
					echo "Rebooting to recovery.....to wipe Dalvik Cache & Cache"
					echo "GoodBye!"
					reboot recovery
					;;
				"2")
					echo "Fine, I will be here when you get back :)"
					echo "This message will self-destruct in ..."
					echo "5"
					sleep 1
					echo "4"
					sleep 1
					echo "3"
					sleep 1
					echo "2"
					sleep 1
					echo "1"
					sleep 1
					echo "P O O F!"
					exit
					;;
			esac
		$confirm
		;;
		"4")
			grep_cmd=`find *.zip`
			echo "Previous configurations:" 
			echo
			for filename in $grep_cmd 
			    do
 			     count=$(($count+1))

 			     filename=`echo $filename | sed 's/temp_space/ /g'`

   			   # Store file names in an array
     			 file_array[$count]=$filename

			      echo "  ($count) $filename" >> temp.list
  			  done

  			  more temp.list
 			  rm temp.list

			    echo
			    echo -n "Enter selection number to flash (exit = 0): "

    			read enterNumber
    			echo
			if [ "$enterNumber" == "0" ]
    			then
      			exit 0
			fi
			if [ "`echo $enterNumber | sed 's/[0-9]*//'`" == "" ] || [ "enterNumber"=="1" ]
    			then
      			file_chosen=${file_array[$enterNumber]}
			fi
			echo "Last chance before we flash" 
			echo "You chose $file_chosen"
			echo 
			echo "1) Yes; I am ready flash it right away"
			echo "2) No; let's just save it for later"
			echo "Confirm flash?"
			read confirm
			case "$confirm" in
				"1")
					echo "Flashing selection in ..."
					echo "5"
					sleep 1
					echo "4"
					sleep 1
					echo "3"
					sleep 1
					echo "2"
					sleep 1
					echo "1"
					sleep 1
					unzip -e -o $file_chosen boot.img -d /sdcard2/lunar/ 2>/dev/null
					dd if=/sdcard2/lunar/boot.img of=/dev/block/$boot 2>/dev/null
					rm boot.img
					echo "Rebooting to recovery....."
					echo "... and finish flashing $file_chosen"
					echo "GoodBye!"
					reboot recovery
					;;
				"2")
					echo "Fine, I will be here when you get back :)"
					echo "This message will self-destruct in ..."
					echo "5"
					sleep 1
					echo "4"
					sleep 1
					echo "3"
					sleep 1
					echo "2"
					sleep 1
					echo "1"
					sleep 1
					echo "P O O F!"
					exit
					;;
			esac
		$confirm
		;;
		"99")
			exit
			;;
        esac
$menu
